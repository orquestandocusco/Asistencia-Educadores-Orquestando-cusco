<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asistencia Orquestando</title>

<!-- üî• FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- üìä EXCEL XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background-image: url("fondo-orquestando.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  margin: 0;
  padding: 0;
}

.contenedor {
  background: rgba(255,255,255,0.93);
  max-width: 1200px;
  margin: 30px auto;
  padding: 20px;
  border-radius: 15px;
}

.logo {
  max-width: 320px;
  margin: 10px auto;
}

select, input, button {
  padding: 10px;
  margin: 6px;
  font-size: 14px;
}

button { cursor: pointer; }

.encabezado-semana, .semana {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
}

.encabezado-semana div {
  font-weight: bold;
  background: #ddd;
  padding: 8px;
  border: 1px solid #bbb;
}

.dia {
  border: 1px solid #ccc;
  min-height: 95px;
  padding: 6px;
  font-size: 12px;
}

.fin-semana { background: #ffe0e0; }

.Entrada { border-left: 6px solid green; }
.Salida { border-left: 6px solid blue; }
.Permiso { border-left: 6px solid orange; }
.TrabajoRemoto { border-left: 6px solid purple; }
.Falta { border-left: 6px solid red; }
.Salud { border-left: 6px solid deepskyblue; }

.calendario-wrapper {
  transform: scale(0.67);
  transform-origin: top center;
  margin-top: 30px;
  padding-top: 20px;
}

.admin-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: #000;
  color: #fff;
  font-weight: bold;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0.15;
}
.admin-btn:hover { opacity: 1; }

.admin-panel {
  display: none;
  background: #f5f5f5;
  padding: 15px;
  border-radius: 10px;
  margin-top: 15px;
}
</style>
</head>

<body>

<div class="contenedor">

  <div style="position: relative; display: inline-block;">
    <img src="logo-orquestando.png" class="logo">
    <div class="admin-btn" onclick="abrirAdmin()">O</div>
  </div>

  <h1>SISTEMA DE ASISTENCIA ‚Äì ORQUESTANDO</h1>

  <select id="educador">
    <option value="">üë§ Seleccione educador</option>
    <option>Elvis Ylla Uscamayta</option>
    <option>Nilton Ibarra Vilchez</option>
    <option>Hector Roberto Galvez Zu√±iga</option>
  </select>

  <input type="password" id="pin" placeholder="üîê PIN 5 d√≠gitos" maxlength="5"><br>

  <button onclick="marcar('entrada')">üü¢ Entrada</button>
  <button onclick="marcar('salida')">üîµ Salida</button>

  <div class="admin-panel" id="adminPanel">
    <h3>üîß MODO ADMINISTRADOR</h3>

    <select id="adminEducador">
      <option value="">Seleccione educador</option>
      <option>Elvis Ylla Uscamayta</option>
      <option>Nilton Ibarra Vilchez</option>
      <option>Hector Roberto Galvez Zu√±iga</option>
    </select>

    <input type="date" id="adminFecha">
    <input type="time" id="adminEntrada" step="1">
    <input type="time" id="adminSalida" step="1"><br>

    <select id="adminEstado">
      <option value="">‚Äî Estado especial ‚Äî</option>
      <option value="Permiso">üü† Permiso</option>
      <option value="Trabajo Remoto">üü£ Trabajo Remoto</option>
      <option value="Falta">üî¥ Falta injustificada</option>
      <option value="Salud">üü¶ Permiso por salud</option>
    </select><br>

    <button onclick="guardarEdicion()">üíæ Guardar cambios</button>
  </div>

  <hr>

  <select id="mes"></select>
  <select id="anio"></select><br>

  <button onclick="verAsistencias()">üìÖ Ver asistencias</button>
  <button onclick="descargarExcel()">üì• Descargar Excel</button>

  <div class="calendario-wrapper">
    <div class="encabezado-semana">
      <div>S√ÅB</div><div>DOM</div><div>LUN</div><div>MAR</div>
      <div>MI√â</div><div>JUE</div><div>VIE</div>
    </div>
    <div id="calendario"></div>
  </div>

</div>

<script>
/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyB5DmQh3_4qOZKejJWP2Ul4MJ2qeV_QYCg",
  authDomain: "asistencia-orquestando.firebaseapp.com",
  projectId: "asistencia-orquestando",
  storageBucket: "asistencia-orquestando.firebasestorage.app",
  messagingSenderId: "871572030454",
  appId: "1:871572030454:web:a79ec963141b20e1647dd7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* PINES */
const pines = {
  "Elvis Ylla Uscamayta": "20261",
  "Nilton Ibarra Vilchez": "20262",
  "Hector Roberto Galvez Zu√±iga": "20263"
};
const PIN_ADMIN = "99999";

/* SELECTORES */
const mesSel = document.getElementById("mes");
const anioSel = document.getElementById("anio");
const educadorSel = document.getElementById("educador");
const calendario = document.getElementById("calendario");

/* MESES Y A√ëOS */
["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]
.forEach((m,i)=>mesSel.innerHTML+=`<option value="${i}">${m}</option>`);

for (let y = 2026; y <= 2035; y++) anioSel.innerHTML += `<option>${y}</option>`;

/* üì• DESCARGAR EXCEL XLSX */
async function descargarExcel() {
  const educador = educadorSel.value;
  if (!educador) return alert("Seleccione un educador");

  const anio = anioSel.value;
  const mes = String(Number(mesSel.value) + 1).padStart(2,"0");

  const snapshot = await db.collection("asistencias").get();

  const datos = [["Educador","Fecha","Entrada","Salida","Estado"]];

  snapshot.forEach(doc => {
    const id = doc.id;
    if (id.startsWith(educador)) {
      const fecha = id.slice(-10);
      if (fecha.startsWith(`${anio}-${mes}`)) {
        const d = doc.data();
        datos.push([
          educador,
          fecha,
          d.entrada || "",
          d.salida || "",
          d.estado || ""
        ]);
      }
    }
  });

  if (datos.length === 1) return alert("No hay datos");

  const hoja = XLSX.utils.aoa_to_sheet(datos);
  const libro = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(libro, hoja, "Asistencias");

  XLSX.writeFile(libro, `Asistencia_${educador}_${anio}_${mes}.xlsx`);
}
</script>

</body>
</html>
