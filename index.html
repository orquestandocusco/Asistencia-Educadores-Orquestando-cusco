<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asistencia Orquestando</title>

<!-- ğŸ”¥ FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background-image: url("fondo-orquestando.jpg");
  background-size: cover;
  background-attachment: fixed;
}

.contenedor {
  background: rgba(255,255,255,0.93);
  max-width: 1200px;
  margin: 30px auto;
  padding: 20px;
  border-radius: 15px;
}

.logo { max-width: 320px; }

select, input, button {
  padding: 10px;
  margin: 6px;
}

.encabezado-semana, .semana {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
}

.encabezado-semana div {
  background: #ddd;
  font-weight: bold;
  padding: 8px;
}

.dia {
  border: 1px solid #ccc;
  min-height: 95px;
  font-size: 12px;
  padding: 5px;
}

.fin-semana { background: #ffe0e0; }

.entrada { border-left: 6px solid green; }
.salida { border-left: 6px solid blue; }
.permiso { border-left: 6px solid orange; }
.falta { border-left: 6px solid red; }
.salud { border-left: 6px solid purple; }

.admin-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: black;
  color: white;
  cursor: pointer;
  opacity: 0.2;
}
.admin-btn:hover { opacity: 1; }

.admin-panel {
  display: none;
  background: #f5f5f5;
  padding: 15px;
  border-radius: 10px;
}
</style>
</head>

<body>

<div class="contenedor">

  <div style="position: relative;">
    <img src="logo-orquestando.png" class="logo">
    <div class="admin-btn" onclick="abrirAdmin()">O</div>
  </div>

  <h2>SISTEMA DE ASISTENCIA â€“ ORQUESTANDO</h2>

  <select id="educador">
    <option value="">Seleccione educador</option>
    <option>Elvis Ylla Uscamayta</option>
    <option>Nilton Ibarra Vilchez</option>
    <option>Hector Roberto Galvez ZuÃ±iga</option>
  </select>

  <input type="password" id="pin" placeholder="PIN">
  <br>

  <button onclick="marcar('entrada')">ğŸŸ¢ Entrada</button>
  <button onclick="marcar('salida')">ğŸ”µ Salida</button>

  <!-- ADMIN -->
  <div id="adminPanel" class="admin-panel">
    <h3>MODO ADMIN</h3>

    <select id="adminEducador">
      <option value="">Educador</option>
      <option>Elvis Ylla Uscamayta</option>
      <option>Nilton Ibarra Vilchez</option>
      <option>Hector Roberto Galvez ZuÃ±iga</option>
    </select>

    <input type="date" id="adminFecha"><br>

    <input type="time" id="adminEntrada">
    <input type="time" id="adminSalida"><br>

    <select id="adminEstado">
      <option value="">Estado especial</option>
      <option value="permiso">ğŸŸ  Permiso</option>
      <option value="falta">ğŸ”´ Falta injustificada</option>
      <option value="salud">ğŸŸ£ Permiso por salud</option>
    </select><br>

    <button onclick="guardarAdmin()">ğŸ’¾ Guardar</button>
  </div>

  <hr>

  <select id="mes"></select>
  <select id="anio"></select>
  <br>

  <button onclick="verAsistencias()">ğŸ“… Ver asistencias</button>

  <div class="encabezado-semana">
    <div>SÃB</div><div>DOM</div><div>LUN</div><div>MAR</div>
    <div>MIÃ‰</div><div>JUE</div><div>VIE</div>
  </div>
  <div id="calendario"></div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyB5DmQh3_4qOZKejJWP2Ul4MJ2qeV_QYCg",
  authDomain: "asistencia-orquestando.firebaseapp.com",
  projectId: "asistencia-orquestando"
});
const db = firebase.firestore();

/* PINES */
const pines = {
  "Elvis Ylla Uscamayta": "20261",
  "Nilton Ibarra Vilchez": "20262",
  "Hector Roberto Galvez ZuÃ±iga": "20263"
};
const PIN_ADMIN = "99999";

/* SELECTORES */
const mesSel = document.getElementById("mes");
const anioSel = document.getElementById("anio");
const calendario = document.getElementById("calendario");

/* MESES */
["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]
.forEach((m,i)=>mesSel.innerHTML+=`<option value="${i}">${m}</option>`);
for(let y=2025;y<=2035;y++) anioSel.innerHTML+=`<option>${y}</option>`;

/* MARCAR NORMAL */
async function marcar(tipo){
  const e = educador.value;
  if(pin.value !== pines[e]) return alert("PIN incorrecto");

  const f = new Date().toISOString().split("T")[0];
  const h = new Date().toLocaleTimeString("es-PE",{hour12:true});

  await db.collection("asistencias").doc(`${e}-${f}`).set({
    [tipo]: h,
    estado: null
  },{merge:true});

  alert("Registrado");
}

/* ADMIN */
function abrirAdmin(){
  if(prompt("PIN ADMIN")===PIN_ADMIN)
    adminPanel.style.display="block";
}

async function guardarAdmin(){
  const e = adminEducador.value;
  const f = adminFecha.value;
  if(!e||!f) return alert("Datos incompletos");

  const data = {
    entrada: adminEntrada.value,
    salida: adminSalida.value,
    estado: adminEstado.value || null
  };

  await db.collection("asistencias").doc(`${e}-${f}`).set(data,{merge:true});
  alert("Guardado");
}

/* VER ASISTENCIAS */
async function verAsistencias(){
  calendario.innerHTML="";
  const e = educador.value;
  const y = +anioSel.value;
  const m = +mesSel.value;

  const snap = await db.collection("asistencias")
    .where(firebase.firestore.FieldPath.documentId(),">=",e+"-")
    .where(firebase.firestore.FieldPath.documentId(),"<",e+"-\uf8ff")
    .get();

  const data = {};
  snap.forEach(d=>data[d.id]=d.data());

  const days = new Date(y,m+1,0).getDate();
  let semana=document.createElement("div");
  semana.className="semana";
  calendario.appendChild(semana);

  for(let d=1;d<=days;d++){
    const date=new Date(y,m,d);
    const key=`${e}-${date.toISOString().split("T")[0]}`;
    const r=data[key]||{};
    const div=document.createElement("div");
    div.className="dia "+(r.estado||"");
    div.innerHTML=`<b>${d}</b><br>
      ${r.estado==="permiso"?"ğŸŸ  Permiso":""}
      ${r.estado==="falta"?"ğŸ”´ Falta":""}
      ${r.estado==="salud"?"ğŸŸ£ Salud":""}
      ${!r.estado && r.entrada? "ğŸŸ¢ "+r.entrada:""}
      ${!r.estado && r.salida? "<br>ğŸ”µ "+r.salida:""}`;
    semana.appendChild(div);
  }
}
</script>

</body>
</html>
