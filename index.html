<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asistencia Orquestando</title>

<!-- ğŸ”¥ FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- ğŸ“Š XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  text-align:center;
  background-image:url("fondo-orquestando.jpg");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
  margin:0;
}
.contenedor{
  background:rgba(255,255,255,0.93);
  max-width:1200px;
  margin:30px auto;
  padding:20px;
  border-radius:15px;
}
.logo{max-width:320px;}
select,input,button{padding:10px;margin:6px;}
.encabezado-semana,.semana{
  display:grid;
  grid-template-columns:repeat(7,1fr);
}
.encabezado-semana div{
  background:#ddd;
  border:1px solid #bbb;
  padding:8px;
  font-weight:bold;
}
.dia{
  border:1px solid #ccc;
  min-height:95px;
  font-size:12px;
  padding:6px;
}
.fin-semana{background:#ffe0e0;}
.Entrada{border-left:6px solid green;}
.Salida{border-left:6px solid blue;}
.Permiso{border-left:6px solid orange;}
.TrabajoRemoto{border-left:6px solid purple;}
.Falta{border-left:6px solid red;}
.Salud{border-left:6px solid deepskyblue;}
.calendario-wrapper{
  transform:scale(0.67);
  transform-origin:top center;
}
.admin-btn{
  position:absolute;
  top:20px;
  right:20px;
  width:38px;
  height:38px;
  border-radius:50%;
  background:black;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:.15;
  cursor:pointer;
}
.admin-btn:hover{opacity:1;}
.admin-panel{
  display:none;
  background:#f5f5f5;
  padding:15px;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="contenedor">

<div style="position:relative;display:inline-block;">
<img src="logo-orquestando.png" class="logo">
<div class="admin-btn" onclick="abrirAdmin()">O</div>
</div>

<h1>SISTEMA DE ASISTENCIA EDUCADORESâ€“ ORQUESTANDO</h1>

<select id="educador">
<option value="">ğŸ‘¤ Seleccione educador</option>
<option>Elvis Ylla Uscamayta</option>
<option>Nilton Ibarra Vilchez</option>
<option>Hector Roberto Galvez ZuÃ±iga</option>
</select>

<input type="password" id="pin" placeholder="ğŸ” PIN 5 dÃ­gitos" maxlength="5"><br>

<button onclick="marcar('entrada')">ğŸŸ¢ Entrada</button>
<button onclick="marcar('salida')">ğŸ”µ Salida</button>

<div class="admin-panel" id="adminPanel">
<h3>ğŸ”§ MODO ADMINISTRADOR</h3>

<select id="adminEducador">
<option value="">Seleccione educador</option>
<option>Elvis Ylla Uscamayta</option>
<option>Nilton Ibarra Vilchez</option>
<option>Hector Roberto Galvez ZuÃ±iga</option>
</select>

<input type="date" id="adminFecha">
<input type="time" id="adminEntrada" step="1">
<input type="time" id="adminSalida" step="1"><br>

<select id="adminEstado">
<option value="">â€” Estado especial â€”</option>
<option value="Permiso">ğŸŸ  Permiso</option>
<option value="Trabajo Remoto">ğŸŸ£ Trabajo Remoto</option>
<option value="Falta">ğŸ”´ Falta injustificada</option>
<option value="Salud">ğŸŸ¦ Permiso por salud</option>
</select><br>

<button onclick="guardarEdicion()">ğŸ’¾ Guardar cambios</button>
</div>

<hr>

<select id="mes"></select>
<select id="anio"></select><br>

<button onclick="verAsistencias()">ğŸ“… Ver asistencias</button>
<button onclick="descargarExcel()">ğŸ“¥ Descargar Excel</button>

<div class="calendario-wrapper">
<div class="encabezado-semana">
<div>SÃB</div><div>DOM</div><div>LUN</div><div>MAR</div>
<div>MIÃ‰</div><div>JUE</div><div>VIE</div>
</div>
<div id="calendario"></div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyB5DmQh3_4qOZKejJWP2Ul4MJ2qeV_QYCg",
  authDomain:"asistencia-orquestando.firebaseapp.com",
  projectId:"asistencia-orquestando"
});
const db=firebase.firestore();

const pines={
  "Elvis Ylla Uscamayta":"20261",
  "Nilton Ibarra Vilchez":"20262",
  "Hector Roberto Galvez ZuÃ±iga":"20263"
};
const PIN_ADMIN="99999";

const mesSel=document.getElementById("mes");
const anioSel=document.getElementById("anio");
const educadorSel=document.getElementById("educador");
const calendario=document.getElementById("calendario");

["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]
.forEach((m,i)=>mesSel.innerHTML+=`<option value="${i}">${m}</option>`);
for(let y=2026;y<=2035;y++)anioSel.innerHTML+=`<option>${y}</option>`;

async function marcar(tipo){
  const e = educadorSel.value;
  const pin = document.getElementById("pin").value;

  if(!e){
    return alert("âŒ Seleccione educador");
  }
  if(pin !== pines[e]){
    return alert("âŒ PIN incorrecto");
  }
  
  const ahora=new Date();
  const fecha=ahora.toISOString().split("T")[0];
  const hora=ahora.toLocaleTimeString("es-PE",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:true});
  await db.collection("asistencias").doc(`${e}-${fecha}`)
    .set({[tipo]:hora,estado:null},{merge:true});
  alert("Registrado");
}

function abrirAdmin(){
  if(prompt("PIN ADMIN")===PIN_ADMIN)
    document.getElementById("adminPanel").style.display="block";
  else
    alert("âŒ PIN ADMIN incorrecto");
}

async function guardarEdicion(){
  const e=document.getElementById("adminEducador").value;
  const f=document.getElementById("adminFecha").value;
  const estado=document.getElementById("adminEstado").value;
  const entrada=document.getElementById("adminEntrada").value;
  const salida=document.getElementById("adminSalida").value;
  if(!e||!f)return;
  await db.collection("asistencias").doc(`${e}-${f}`).set({
    entrada:estado?null:entrada,
    salida:estado?null:salida,
    estado:estado||null
  },{merge:true});
  alert("Actualizado");
}

async function verAsistencias(){
  calendario.innerHTML="";
  const e=educadorSel.value;
  if(!e) return alert("Seleccione educador y mes");
  const anio=parseInt(anioSel.value);
  const mes=parseInt(mesSel.value);

  const snap=await db.collection("asistencias").get();
  const data={};
  snap.forEach(d=>data[d.id]=d.data());

  const primer=new Date(anio,mes,1);
  const ultimo=new Date(anio,mes+1,0).getDate();

  let fila=document.createElement("div");
  fila.className="semana";
  calendario.appendChild(fila);

  let offset=(primer.getDay()+1)%7;
  for(let i=0;i<offset;i++)fila.appendChild(document.createElement("div"));

  for(let d=1;d<=ultimo;d++){
    const f=new Date(anio,mes,d);
    const key=`${e}-${f.toISOString().split("T")[0]}`;
    const r=data[key]||{};
    const div=document.createElement("div");
    div.className="dia";
    if([0,6].includes(f.getDay()))div.classList.add("fin-semana");
    if(r.estado)div.classList.add(r.estado.replace(" ",""));
    if(r.entrada)div.classList.add("Entrada");
    if(r.salida)div.classList.add("Salida");
    div.innerHTML=`<strong>${d}</strong>
      ${r.estado?`<br>${r.estado}`:""}
      ${r.entrada?`<br>ğŸŸ¢ ${r.entrada}`:""}
      ${r.salida?`<br>ğŸ”µ ${r.salida}`:""}`;
    fila.appendChild(div);
    if(f.getDay()===5&&d!==ultimo){
      fila=document.createElement("div");
      fila.className="semana";
      calendario.appendChild(fila);
    }
  }
}

async function descargarExcel(){
  const e = educadorSel.value;
  if(!e) return alert("Seleccione educador");

  const anio = anioSel.value;
  const mesNum = +mesSel.value; // 0â€“11
  const mes = String(mesNum + 1).padStart(2,"0");

  const snap = await db.collection("asistencias").get();

  const rows = [["Educador","Fecha","DÃ­a","Entrada","Salida","Estado"]];

  snap.forEach(doc=>{
    if(doc.id.startsWith(e)){
      const fecha = doc.id.slice(-10); // YYYY-MM-DD

      if(fecha.startsWith(`${anio}-${mes}`)){
        const d = doc.data();

        const fechaObj = new Date(fecha + "T00:00:00");
        const diaSemana = fechaObj.getDay(); // 0 domingo, 6 sÃ¡bado
        const esFinSemana = diaSemana === 0 || diaSemana === 6;

        rows.push([
          e,
          fecha,
          fechaObj.toLocaleDateString("es-PE",{ weekday:"long" }),
          esFinSemana ? "â€”" : (d.entrada || ""),
          esFinSemana ? "â€”" : (d.salida || ""),
          esFinSemana ? "DÃ­a no laborable" : (d.estado || "")
        ]);
      }
    }
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Asistencia");

  XLSX.writeFile(wb, `Asistencia_${e}_${anio}_${mes}.xlsx`);
}
</script>
</body>
</html>
